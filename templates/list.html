{% extends "base.html" %}
{% block title %}äº¤é€šè²»ä¸€è¦§{% endblock %}
{% block content %}
<h2>
    {% if status_filter == 'pending' %}ğŸ•’ æ‰¿èªå¾…ã¡ä¸€è¦§
    {% else %}äº¤é€šè²»ä¸€è¦§
    {% endif %}
</h2>
<form method="get" class="mb-3 d-flex align-items-center gap-3">

    <!-- æœˆãƒ•ã‚£ãƒ«ã‚¿ -->
    <div>
      <label class="form-label me-1 mb-0">æœˆ</label>
      <input type="month" name="month" value="{{ month_selected }}"
             class="form-control d-inline-block" style="width:180px"
             onchange="this.form.submit()">
    </div>
  
    <!-- ç”³è«‹è€…ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ‰¿èªè€…ã ã‘è¡¨ç¤ºï¼‰ -->
    {% if current_user.role == 'admin' %}
      <div>
        <label class="form-label me-1 mb-0">ç”³è«‹è€…</label>
        <select name="user" class="form-select d-inline-block"
                style="width:200px" onchange="this.form.submit()">
          <option value="all" {% if user_selected=='all' %}selected{% endif %}>å…¨å“¡</option>
          {% for u in users %}
            <option value="{{ u.username }}"
                    {% if user_selected==u.username %}selected{% endif %}>
              {{ u.username }}
            </option>
          {% endfor %}
        </select>
      </div>
    {% endif %}
  
    <!-- ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼ˆã©ã¡ã‚‰ã‹é¸æŠã—ã¦ã„ã‚‹æ™‚ã ã‘ï¼‰ -->
    {% if month_selected or (user_selected != 'all') %}
      <a href="{{ url_for('expenses.list_expenses') }}" class="btn btn-link">ã‚¯ãƒªã‚¢</a>
    {% endif %}
  </form>  
<div class="table-responsive"> 
  <table class="table table-bordered align-middle mb-0 list-table">
    <thead class="table-light">
        <tr>
          {% if show_user_col %}<th>ç”³è«‹è€…</th>{% endif %}
          <th>æ—¥ä»˜</th><th>å‡ºç™º</th><th>åˆ°ç€</th>
          <th>äº¤é€šæ©Ÿé–¢</th>
          <th class="text-end">é‡‘é¡</th><th>ãƒ¡ãƒ¢</th>
          <th>é ˜åæ›¸</th><th>çŠ¶æ…‹ / æ“ä½œ</th>
          <th style="width:120px">æœ€çµ‚ç¢ºèª</th>
        </tr>
      </thead>
      <tbody>
        {% for e in expenses %}
          <tr>
            {# ç”³è«‹è€…ã‚»ãƒ«ï¼ˆæ‰¿èªè€… & å…¨å“¡ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰ #}
            {% if show_user_col %}
              <td>{{ e.user.username }}</td>
            {% endif %}
        
            <td>{{ e.date }}</td>
            <td>{{ e.departure }}</td>
            <td>{{ e.destination }}</td>
            <td>{{ e.transport }}</td>
            <td class="text-end">{{ "{:,}".format(e.amount) }}</td>
            <td>{{ e.memo or "" }}</td>
        
            <td>
                {# â”€â”€ 1) æ–°æ–¹å¼ï¼šExpense.receipts (æœ€å¤§5æš) â”€â”€ #}
                {% if e.receipts %}
                  {% for r in e.receipts %}
                    <a href="{{ r.file_path }}" target="_blank">ğŸ“„{{ loop.index }}</a>
                    {% if not loop.last %}<br>{% endif %}
                  {% endfor %}
                {% endif %}
              
                {# â”€â”€ 2) æ—§æ–¹å¼ï¼šExpense.file_path ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ â”€â”€ #}
                {% if e.file_path %}
                  {% if e.file_path.startswith('http') %}
                    <a href="{{ e.file_path }}" target="_blank">ğŸ“„</a>
                  {% else %}
                    <a href="{{ url_for('expenses.view_receipt',
                                        filename=e.file_path.split('/')[-1]) }}"
                       target="_blank">ğŸ“„</a>
                  {% endif %}
                {% endif %}
              </td>                            
        
            <td>
              {# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ Badgeï¼ˆå’Œè¨³ä»˜ãï¼‰ #}
              {% set label = {
                'pending':'æ‰¿èªå¾…ã¡',
                'approved':'æ‰¿èªæ¸ˆã¿',
                'rejected':'å´ä¸‹æ¸ˆã¿',
                'canceled':'å–æ¶ˆæ¸ˆã¿'
              }[e.status] %}
              {% set badge_cls = {
                'pending':'badge-pending',
                'approved':'badge-approved',
                'rejected':'badge-rejected',
                'canceled':'badge-canceled'
              }[e.status] %}
              <span class="badge {{ badge_cls }}">{{ label }}</span>  
              
              {# carried_forward ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç¿Œæœˆã¸æŒ¯æ›¿æ¸ˆã¿ï¼‰ #}
              {% if e.carried_forward %}
                <span class="text-info ms-1" title="ç¿ŒæœˆæŒ¯æ›¿æ¸ˆ">ğŸ”„</span>
              {% endif %}
        
              {# ------------------------------------------------------------
                 æ‰¿èªè€…(admin) ã®æ“ä½œ
                 ------------------------------------------------------------ #}
              {% if current_user.role == 'admin' %}
        
                {# æ‰¿èªï¼å´ä¸‹ï¼šã©ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚‚è¡¨ç¤ºã€‚ç¾åœ¨ã¨åŒã˜ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹åŒ– #}
                <form method="post"
                      action="{{ url_for('expenses.approve', eid=e.id) }}"
                      class="d-inline">
                  <button class="btn btn-sm btn-success
                                 {% if e.status == 'approved' %}disabled{% endif %}">
                    æ‰¿èª
                  </button>
                </form>
        
                <form method="post"
                      action="{{ url_for('expenses.reject', eid=e.id) }}"
                      class="d-inline">
                  <button class="btn btn-sm btn-danger
                                 {% if e.status == 'rejected' %}disabled{% endif %}">
                    å´ä¸‹
                  </button>
                </form>
        
                {# å‰Šé™¤ã¯å¸¸ã«å¯ #}
                <form method="post"
                      action="{{ url_for('expenses.delete_expense', eid=e.id) }}"
                      class="d-inline"
                      onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                  <button class="btn btn-sm btn-outline-secondary">å‰Šé™¤</button>
                </form>

                {% if not e.carried_forward %}
                <form method="post" action="{{ url_for('expenses.carry_forward', eid=e.id) }}"
                      class="d-inline">
                  <button class="btn btn-sm btn-outline-info">ç¿Œæœˆã¸</button>
                </form>
              {% else %}
                <form method="post" action="{{ url_for('expenses.undo_carry', eid=e.id) }}"
                      class="d-inline">
                  <button class="btn btn-sm btn-outline-warning">å‰æœˆã¸æˆ»ã™</button>
                </form>
              {% endif %}
            
            {% elif current_user.id == e.user_id and e.status == 'pending' %}
            
              {# ç”³è«‹è€…: è‡ªåˆ†ã® pending è¡Œã ã‘å–æ¶ˆå¯èƒ½ #}
              <form method="post" action="{{ url_for('expenses.delete_expense', eid=e.id) }}"
                    class="d-inline" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                <button class="btn btn-sm btn-outline-secondary">å–æ¶ˆ</button>
              </form>
            
            {% endif %}
            </td>
            {% if current_user.role == 'admin' %}
            <td>
              {% if not e.final_checked %}
                <form method="post"
                      action="{{ url_for('expenses.final_check', eid=e.id) }}"
                      class="d-inline">
                  <button class="btn btn-sm btn-outline-primary">âœ”ï¸ æ¸ˆ</button>
                </form>
              {% else %}
                <form method="post"
                      action="{{ url_for('expenses.undo_final_check', eid=e.id) }}"
                      class="d-inline">
                  <button class="btn btn-sm btn-outline-secondary">â†©ï¸ å–æ¶ˆ</button>
                </form>
              {% endif %}
            </td>
          {% endif %}
          </tr>
        {% endfor %}
        </tbody>                
        <tfoot>
            <tr>
              <th colspan="{{ 5 if show_user_col else 4 }}" class="text-end">
                åˆè¨ˆ <small>(ç¨è¾¼)</small>
              </th>
              <th class="text-end">{{ "{:,}".format(total) }}</th>
              <th></th>
            </tr>
            <tr>
              <th colspan="{{ 5 if show_user_col else 4 }}" class="text-end">ç¨æŠœé¡</th>
              <th class="text-end">{{ "{:,}".format(net_total) }}</th>
              <th></th>
            </tr>
            <tr>
              <th colspan="{{ 5 if show_user_col else 4 }}" class="text-end">æ¶ˆè²»ç¨é¡</th>
              <th class="text-end">{{ "{:,}".format(tax_amount) }}</th>
              <th></th>
            </tr>
          </tfoot>            
  </table>
</div>
<a href="{{ url_for('expenses.submit') }}" class="btn btn-primary">æ–°è¦å…¥åŠ›</a>
<a href="{{ url_for('expenses.submit') }}"
   class="fab-submit d-sm-none">ï¼‹</a>
{% endblock %}
